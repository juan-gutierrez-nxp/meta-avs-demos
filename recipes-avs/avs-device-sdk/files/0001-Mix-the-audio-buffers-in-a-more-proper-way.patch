From 445355c82b9d1b57f8c2766082aab7902009b0f8 Mon Sep 17 00:00:00 2001
From: Juan Gutierrez <juan.gutierrez@nxp.com>
Date: Fri, 20 Jul 2018 00:27:10 +0000
Subject: [PATCH 1/2] Mix the audio buffers in a more proper way

Signed-off-by: Juan Gutierrez <juan.gutierrez@nxp.com>
---
 SampleApp/src/PortAudioMicrophoneWrapper.cpp | 29 ++++++++++++++++++++++++++--
 1 file changed, 27 insertions(+), 2 deletions(-)

diff --git a/SampleApp/src/PortAudioMicrophoneWrapper.cpp b/SampleApp/src/PortAudioMicrophoneWrapper.cpp
index d3afa4f..6261895 100644
--- a/SampleApp/src/PortAudioMicrophoneWrapper.cpp
+++ b/SampleApp/src/PortAudioMicrophoneWrapper.cpp
@@ -545,9 +545,34 @@ int PortAudioMicrophoneWrapper::PortAudioHardwareCallback(
     wrapper->m_audioMediaPlayer->tryPullAppSink(audioMediaPlayerBuffer, BLOCK_SIZE * NUM_MEDIA_CHANNELS * sizeof(Sample));
     wrapper->m_alertsMediaPlayer->tryPullAppSink(alertsMediaPlayerBuffer, BLOCK_SIZE * NUM_MEDIA_CHANNELS * sizeof(Sample));
 
-    for (i =0; i < (BLOCK_SIZE * NUM_MEDIA_CHANNELS); i++) {
-		  avsOutBuffer[i] = ((SAMPLE)(buffer[i] << 16))/2 + speakMediaPlayerBuffer[i] + audioMediaPlayerBuffer[i] + alertsMediaPlayerBuffer[i];
+    int alexa_audio=0;
+    int aplay_audio=0;
+
+    for (i =0; i < 50; i++) {
+        alexa_audio += speakMediaPlayerBuffer[i] + audioMediaPlayerBuffer[i] + alertsMediaPlayerBuffer[i];
+        aplay_audio += buffer[i];
     }
+//    alexa_audio = !!alexa_audio;
+//    aplay_audio = !!aplay_audio;
+    
+
+    if (alexa_audio & aplay_audio) {
+        for (i =0; i < (BLOCK_SIZE * NUM_MEDIA_CHANNELS); i++) {
+		  avsOutBuffer[i] = ((SAMPLE)(buffer[i] << 16))/2 + (speakMediaPlayerBuffer[i] + audioMediaPlayerBuffer[i] + alertsMediaPlayerBuffer[i])/2;
+        }
+     } 
+     else if (aplay_audio)
+     {
+	     for (i =0; i < (BLOCK_SIZE * NUM_MEDIA_CHANNELS); i++) {
+          avsOutBuffer[i] = ((SAMPLE)(buffer[i] << 16));
+         }
+     }
+     else
+     {
+         for (i =0; i < (BLOCK_SIZE * NUM_MEDIA_CHANNELS); i++) {
+          avsOutBuffer[i] = speakMediaPlayerBuffer[i] + audioMediaPlayerBuffer[i] + alertsMediaPlayerBuffer[i];
+         }
+     }
 
 
     // Prepare AWE buffer
-- 
1.9.1

